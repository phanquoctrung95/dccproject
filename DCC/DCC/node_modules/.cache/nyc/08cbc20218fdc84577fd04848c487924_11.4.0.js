var cov_d0ggvfs9s=function(){var path='D:\\DCC\\DCC\\server\\automatic\\job_send_email\\index.js',hash='a0df0310d335946b503474b04782c2e51dfe0be7',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'D:\\DCC\\DCC\\server\\automatic\\job_send_email\\index.js',statementMap:{'0':{start:{line:1,column:15},end:{line:1,column:39}},'1':{start:{line:2,column:16},end:{line:2,column:51}},'2':{start:{line:3,column:13},end:{line:3,column:36}},'3':{start:{line:5,column:9},end:{line:5,column:22}},'4':{start:{line:6,column:9},end:{line:6,column:22}},'5':{start:{line:7,column:14},end:{line:7,column:37}},'6':{start:{line:9,column:0},end:{line:12,column:54}},'7':{start:{line:10,column:4},end:{line:10,column:47}},'8':{start:{line:12,column:4},end:{line:12,column:54}},'9':{start:{line:14,column:33},end:{line:38,column:1}},'10':{start:{line:15,column:4},end:{line:37,column:7}},'11':{start:{line:16,column:8},end:{line:36,column:9}},'12':{start:{line:17,column:12},end:{line:26,column:15}},'13':{start:{line:27,column:23},end:{line:30,column:13}},'14':{start:{line:31,column:12},end:{line:33,column:13}},'15':{start:{line:32,column:16},end:{line:32,column:116}},'16':{start:{line:34,column:12},end:{line:34,column:39}},'17':{start:{line:35,column:12},end:{line:35,column:59}},'18':{start:{line:39,column:21},end:{line:46,column:1}},'19':{start:{line:40,column:4},end:{line:45,column:7}},'20':{start:{line:41,column:25},end:{line:41,column:49}},'21':{start:{line:42,column:25},end:{line:42,column:49}},'22':{start:{line:43,column:8},end:{line:44,column:44}},'23':{start:{line:49,column:4},end:{line:49,column:32}},'24':{start:{line:51,column:4},end:{line:51,column:14}},'25':{start:{line:52,column:4},end:{line:52,column:27}},'26':{start:{line:53,column:4},end:{line:61,column:5}},'27':{start:{line:54,column:8},end:{line:54,column:45}},'28':{start:{line:55,column:8},end:{line:56,column:23}},'29':{start:{line:56,column:12},end:{line:56,column:23}},'30':{start:{line:57,column:8},end:{line:58,column:28}},'31':{start:{line:58,column:12},end:{line:58,column:28}},'32':{start:{line:59,column:8},end:{line:60,column:27}},'33':{start:{line:60,column:12},end:{line:60,column:27}},'34':{start:{line:62,column:4},end:{line:62,column:14}},'35':{start:{line:66,column:12},end:{line:66,column:13}},'36':{start:{line:67,column:4},end:{line:68,column:12}},'37':{start:{line:68,column:8},end:{line:68,column:12}},'38':{start:{line:69,column:4},end:{line:69,column:28}},'39':{start:{line:73,column:15},end:{line:73,column:44}},'40':{start:{line:74,column:22},end:{line:74,column:63}},'41':{start:{line:75,column:4},end:{line:75,column:39}},'42':{start:{line:76,column:4},end:{line:76,column:41}},'43':{start:{line:77,column:4},end:{line:87,column:5}},'44':{start:{line:79,column:12},end:{line:79,column:18}},'45':{start:{line:81,column:12},end:{line:81,column:45}},'46':{start:{line:82,column:12},end:{line:82,column:18}},'47':{start:{line:84,column:12},end:{line:84,column:39}},'48':{start:{line:85,column:12},end:{line:85,column:18}},'49':{start:{line:88,column:4},end:{line:88,column:16}},'50':{start:{line:90,column:16},end:{line:172,column:1}},'51':{start:{line:92,column:8},end:{line:92,column:18}},'52':{start:{line:93,column:8},end:{line:107,column:11}},'53':{start:{line:94,column:12},end:{line:106,column:13}},'54':{start:{line:95,column:29},end:{line:95,column:58}},'55':{start:{line:96,column:29},end:{line:96,column:67}},'56':{start:{line:97,column:26},end:{line:99,column:67}},'57':{start:{line:98,column:20},end:{line:98,column:67}},'58':{start:{line:100,column:29},end:{line:104,column:17}},'59':{start:{line:105,column:16},end:{line:105,column:32}},'60':{start:{line:110,column:22},end:{line:110,column:41}},'61':{start:{line:111,column:8},end:{line:143,column:9}},'62':{start:{line:112,column:12},end:{line:125,column:15}},'63':{start:{line:113,column:16},end:{line:124,column:17}},'64':{start:{line:114,column:20},end:{line:114,column:45}},'65':{start:{line:115,column:20},end:{line:115,column:42}},'66':{start:{line:117,column:33},end:{line:117,column:58}},'67':{start:{line:118,column:33},end:{line:118,column:67}},'68':{start:{line:120,column:20},end:{line:120,column:45}},'69':{start:{line:121,column:20},end:{line:123,column:64}},'70':{start:{line:122,column:24},end:{line:122,column:76}},'71':{start:{line:127,column:12},end:{line:142,column:15}},'72':{start:{line:128,column:16},end:{line:141,column:17}},'73':{start:{line:129,column:33},end:{line:129,column:58}},'74':{start:{line:130,column:33},end:{line:130,column:67}},'75':{start:{line:131,column:30},end:{line:133,column:63}},'76':{start:{line:132,column:24},end:{line:132,column:71}},'77':{start:{line:134,column:33},end:{line:138,column:21}},'78':{start:{line:139,column:20},end:{line:139,column:37}},'79':{start:{line:150,column:18},end:{line:169,column:10}},'80':{start:{line:154,column:16},end:{line:165,column:19}},'81':{start:{line:155,column:20},end:{line:155,column:33}},'82':{start:{line:156,column:20},end:{line:164,column:21}},'83':{start:{line:158,column:24},end:{line:158,column:109}},'84':{start:{line:160,column:24},end:{line:163,column:26}},'85':{start:{line:161,column:28},end:{line:162,column:105}},'86':{start:{line:170,column:8},end:{line:170,column:20}},'87':{start:{line:173,column:0},end:{line:173,column:27}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:14,column:33},end:{line:14,column:34}},loc:{start:{line:14,column:63},end:{line:38,column:1}},line:14},'1':{name:'(anonymous_1)',decl:{start:{line:15,column:62},end:{line:15,column:63}},loc:{start:{line:15,column:79},end:{line:37,column:5}},line:15},'2':{name:'(anonymous_2)',decl:{start:{line:39,column:21},end:{line:39,column:22}},loc:{start:{line:39,column:33},end:{line:46,column:1}},line:39},'3':{name:'(anonymous_3)',decl:{start:{line:40,column:14},end:{line:40,column:15}},loc:{start:{line:40,column:36},end:{line:45,column:5}},line:40},'4':{name:'binarySearch',decl:{start:{line:48,column:9},end:{line:48,column:21}},loc:{start:{line:48,column:29},end:{line:63,column:1}},line:48},'5':{name:'insertItem',decl:{start:{line:65,column:9},end:{line:65,column:19}},loc:{start:{line:65,column:26},end:{line:70,column:1}},line:65},'6':{name:'createRule',decl:{start:{line:72,column:9},end:{line:72,column:19}},loc:{start:{line:72,column:39},end:{line:89,column:1}},line:72},'7':{name:'(anonymous_7)',decl:{start:{line:91,column:24},end:{line:91,column:25}},loc:{start:{line:91,column:36},end:{line:108,column:5}},line:91},'8':{name:'(anonymous_8)',decl:{start:{line:93,column:34},end:{line:93,column:35}},loc:{start:{line:93,column:43},end:{line:107,column:9}},line:93},'9':{name:'(anonymous_9)',decl:{start:{line:97,column:53},end:{line:97,column:54}},loc:{start:{line:97,column:83},end:{line:99,column:17}},line:97},'10':{name:'(anonymous_10)',decl:{start:{line:109,column:16},end:{line:109,column:17}},loc:{start:{line:109,column:33},end:{line:144,column:5}},line:109},'11':{name:'(anonymous_11)',decl:{start:{line:112,column:46},end:{line:112,column:47}},loc:{start:{line:112,column:54},end:{line:125,column:13}},line:112},'12':{name:'(anonymous_12)',decl:{start:{line:121,column:65},end:{line:121,column:66}},loc:{start:{line:121,column:82},end:{line:123,column:21}},line:121},'13':{name:'(anonymous_13)',decl:{start:{line:127,column:46},end:{line:127,column:47}},loc:{start:{line:127,column:54},end:{line:142,column:13}},line:127},'14':{name:'(anonymous_14)',decl:{start:{line:131,column:57},end:{line:131,column:58}},loc:{start:{line:131,column:87},end:{line:133,column:21}},line:131},'15':{name:'(anonymous_15)',decl:{start:{line:148,column:25},end:{line:148,column:26}},loc:{start:{line:148,column:37},end:{line:171,column:5}},line:148},'16':{name:'(anonymous_16)',decl:{start:{line:152,column:20},end:{line:152,column:21}},loc:{start:{line:152,column:32},end:{line:166,column:13}},line:152},'17':{name:'(anonymous_17)',decl:{start:{line:154,column:69},end:{line:154,column:70}},loc:{start:{line:154,column:83},end:{line:165,column:17}},line:154},'18':{name:'(anonymous_18)',decl:{start:{line:160,column:81},end:{line:160,column:82}},loc:{start:{line:160,column:93},end:{line:163,column:25}},line:160}},branchMap:{'0':{loc:{start:{line:9,column:0},end:{line:12,column:54}},type:'if',locations:[{start:{line:9,column:0},end:{line:12,column:54}},{start:{line:9,column:0},end:{line:12,column:54}}],line:9},'1':{loc:{start:{line:16,column:8},end:{line:36,column:9}},type:'if',locations:[{start:{line:16,column:8},end:{line:36,column:9}},{start:{line:16,column:8},end:{line:36,column:9}}],line:16},'2':{loc:{start:{line:43,column:15},end:{line:44,column:43}},type:'cond-expr',locations:[{start:{line:43,column:41},end:{line:43,column:43}},{start:{line:44,column:12},end:{line:44,column:43}}],line:43},'3':{loc:{start:{line:44,column:12},end:{line:44,column:43}},type:'cond-expr',locations:[{start:{line:44,column:38},end:{line:44,column:39}},{start:{line:44,column:42},end:{line:44,column:43}}],line:44},'4':{loc:{start:{line:55,column:8},end:{line:56,column:23}},type:'if',locations:[{start:{line:55,column:8},end:{line:56,column:23}},{start:{line:55,column:8},end:{line:56,column:23}}],line:55},'5':{loc:{start:{line:57,column:8},end:{line:58,column:28}},type:'if',locations:[{start:{line:57,column:8},end:{line:58,column:28}},{start:{line:57,column:8},end:{line:58,column:28}}],line:57},'6':{loc:{start:{line:59,column:8},end:{line:60,column:27}},type:'if',locations:[{start:{line:59,column:8},end:{line:60,column:27}},{start:{line:59,column:8},end:{line:60,column:27}}],line:59},'7':{loc:{start:{line:77,column:4},end:{line:87,column:5}},type:'switch',locations:[{start:{line:78,column:8},end:{line:79,column:18}},{start:{line:80,column:8},end:{line:82,column:18}},{start:{line:83,column:8},end:{line:85,column:18}},{start:{line:86,column:8},end:{line:86,column:16}}],line:77},'8':{loc:{start:{line:111,column:8},end:{line:143,column:9}},type:'if',locations:[{start:{line:111,column:8},end:{line:143,column:9}},{start:{line:111,column:8},end:{line:143,column:9}}],line:111},'9':{loc:{start:{line:113,column:16},end:{line:124,column:17}},type:'if',locations:[{start:{line:113,column:16},end:{line:124,column:17}},{start:{line:113,column:16},end:{line:124,column:17}}],line:113},'10':{loc:{start:{line:128,column:16},end:{line:141,column:17}},type:'if',locations:[{start:{line:128,column:16},end:{line:141,column:17}},{start:{line:128,column:16},end:{line:141,column:17}}],line:128}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0,'67':0,'68':0,'69':0,'70':0,'71':0,'72':0,'73':0,'74':0,'75':0,'76':0,'77':0,'78':0,'79':0,'80':0,'81':0,'82':0,'83':0,'84':0,'85':0,'86':0,'87':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0,0,0],'8':[0,0],'9':[0,0],'10':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();var schedule=(cov_d0ggvfs9s.s[0]++,require('node-schedule'));var sendEmail=(cov_d0ggvfs9s.s[1]++,require('../../notification/email'));var models=(cov_d0ggvfs9s.s[2]++,require('../../models'));var Jobs;var os=(cov_d0ggvfs9s.s[3]++,require('os'));var fs=(cov_d0ggvfs9s.s[4]++,require('fs'));var CronJob=(cov_d0ggvfs9s.s[5]++,require('cron').CronJob);var settings;cov_d0ggvfs9s.s[6]++;if(fs.existsSync('settings.js')==true){cov_d0ggvfs9s.b[0][0]++;cov_d0ggvfs9s.s[7]++;settings=require('../../../settings.js');}else{cov_d0ggvfs9s.b[0][1]++;cov_d0ggvfs9s.s[8]++;settings=require('../../../settingsDefault.js');}cov_d0ggvfs9s.s[9]++;var sendNewNotificationToEmail=function(email,EmailPeriod){cov_d0ggvfs9s.f[0]++;cov_d0ggvfs9s.s[10]++;models.Notifications.getAllNewNotificationsByEmail(email,notifications=>{cov_d0ggvfs9s.f[1]++;cov_d0ggvfs9s.s[11]++;if(notifications.length>0){cov_d0ggvfs9s.b[1][0]++;cov_d0ggvfs9s.s[12]++;models.Notifications.update({status:0},{where:{email:email,status:{$ne:0}}});var noti=(cov_d0ggvfs9s.s[13]++,{subject:'[DEK] In this '+EmailPeriod+'new notifications ',content:'[DEK] In this '+EmailPeriod+'new notifications '+os.EOL});cov_d0ggvfs9s.s[14]++;for(var i=0;i<notifications.length;i++){cov_d0ggvfs9s.s[15]++;noti.content+=i+1+'. '+notifications[i].title+' : '+notifications[i].content+os.EOL;}cov_d0ggvfs9s.s[16]++;noti.content+='Regards,';cov_d0ggvfs9s.s[17]++;sendEmail([email],noti.subject,noti.content);}else{cov_d0ggvfs9s.b[1][1]++;}});};cov_d0ggvfs9s.s[18]++;var sortJobByEmail=function(){cov_d0ggvfs9s.f[2]++;cov_d0ggvfs9s.s[19]++;Jobs.sort(function(prev,next){cov_d0ggvfs9s.f[3]++;var upper_prev=(cov_d0ggvfs9s.s[20]++,prev.email.toUpperCase());var upper_next=(cov_d0ggvfs9s.s[21]++,next.email.toUpperCase());cov_d0ggvfs9s.s[22]++;return upper_prev<upper_next?(cov_d0ggvfs9s.b[2][0]++,-1):(cov_d0ggvfs9s.b[2][1]++,upper_prev>upper_next?(cov_d0ggvfs9s.b[3][0]++,1):(cov_d0ggvfs9s.b[3][1]++,0));});};function binarySearch(email){cov_d0ggvfs9s.f[4]++;cov_d0ggvfs9s.s[23]++;email=email.toUpperCase();var mid,first,last;cov_d0ggvfs9s.s[24]++;first=0;cov_d0ggvfs9s.s[25]++;last=Jobs.length-1;cov_d0ggvfs9s.s[26]++;while(first<=last){cov_d0ggvfs9s.s[27]++;mid=Math.floor((last+first)/2);cov_d0ggvfs9s.s[28]++;if(email===Jobs[mid].email){cov_d0ggvfs9s.b[4][0]++;cov_d0ggvfs9s.s[29]++;return mid;}else{cov_d0ggvfs9s.b[4][1]++;}cov_d0ggvfs9s.s[30]++;if(email>Jobs[mid].email){cov_d0ggvfs9s.b[5][0]++;cov_d0ggvfs9s.s[31]++;first=mid+1;}else{cov_d0ggvfs9s.b[5][1]++;}cov_d0ggvfs9s.s[32]++;if(email<Jobs[mid].email){cov_d0ggvfs9s.b[6][0]++;cov_d0ggvfs9s.s[33]++;last=mid-1;}else{cov_d0ggvfs9s.b[6][1]++;}}cov_d0ggvfs9s.s[34]++;return-1;}function insertItem(item){cov_d0ggvfs9s.f[5]++;var i=(cov_d0ggvfs9s.s[35]++,0);cov_d0ggvfs9s.s[36]++;while(Jobs[i].email<item.email){cov_d0ggvfs9s.s[37]++;i++;}cov_d0ggvfs9s.s[38]++;Jobs.splice(i,0,item);}function createRule(date,EmailPeriod){cov_d0ggvfs9s.f[6]++;var rule=(cov_d0ggvfs9s.s[39]++,new schedule.RecurrenceRule());const EmailTime=(cov_d0ggvfs9s.s[40]++,settings.NotificationEmailTime.split(':'));cov_d0ggvfs9s.s[41]++;rule.hour=parseInt(EmailTime[0]);cov_d0ggvfs9s.s[42]++;rule.minute=parseInt(EmailTime[1]);cov_d0ggvfs9s.s[43]++;switch(EmailPeriod){case'Daily':cov_d0ggvfs9s.b[7][0]++;cov_d0ggvfs9s.s[44]++;break;case'Weekly':cov_d0ggvfs9s.b[7][1]++;cov_d0ggvfs9s.s[45]++;rule.dayOfWeek=[date.getDay()];cov_d0ggvfs9s.s[46]++;break;case'Monthly':cov_d0ggvfs9s.b[7][2]++;cov_d0ggvfs9s.s[47]++;rule.date=date.getDate();cov_d0ggvfs9s.s[48]++;break;default:cov_d0ggvfs9s.b[7][3]++;}cov_d0ggvfs9s.s[49]++;return rule;}var automatic=(cov_d0ggvfs9s.s[50]++,{createJobSendEmail:function(){cov_d0ggvfs9s.f[7]++;cov_d0ggvfs9s.s[51]++;Jobs=[];cov_d0ggvfs9s.s[52]++;models.User.getEmailUsers(users=>{cov_d0ggvfs9s.f[8]++;cov_d0ggvfs9s.s[53]++;for(let i=0;i<users.length;i++){const date=(cov_d0ggvfs9s.s[54]++,new Date(users[i].TimeOption));const rule=(cov_d0ggvfs9s.s[55]++,createRule(date,users[i].EmailPeriod));const j=(cov_d0ggvfs9s.s[56]++,schedule.scheduleJob(rule,function(email,EmailPeriod){cov_d0ggvfs9s.f[9]++;cov_d0ggvfs9s.s[57]++;sendNewNotificationToEmail(email,EmailPeriod);}.bind(null,users[i].email,users[i].EmailPeriod)));const item=(cov_d0ggvfs9s.s[58]++,{email:users[i].email.toUpperCase(),job:j,EmailPeriod:users[i].EmailPeriod});cov_d0ggvfs9s.s[59]++;Jobs.push(item);}});},updateJobs:function(email){cov_d0ggvfs9s.f[10]++;const index=(cov_d0ggvfs9s.s[60]++,binarySearch(email));cov_d0ggvfs9s.s[61]++;if(index!==-1){cov_d0ggvfs9s.b[8][0]++;cov_d0ggvfs9s.s[62]++;models.User.getUserByEmail(email,user=>{cov_d0ggvfs9s.f[11]++;cov_d0ggvfs9s.s[63]++;if(user.isNotificationEmail===0){cov_d0ggvfs9s.b[9][0]++;cov_d0ggvfs9s.s[64]++;Jobs[index].job.cancel();cov_d0ggvfs9s.s[65]++;Jobs.splice(index,1);}else{cov_d0ggvfs9s.b[9][1]++;const date=(cov_d0ggvfs9s.s[66]++,new Date(user.TimeOption));const rule=(cov_d0ggvfs9s.s[67]++,createRule(date,user.EmailPeriod));cov_d0ggvfs9s.s[68]++;Jobs[index].job.cancel();cov_d0ggvfs9s.s[69]++;Jobs[index].job=schedule.scheduleJob(rule,function(email){cov_d0ggvfs9s.f[12]++;cov_d0ggvfs9s.s[70]++;sendNewNotificationToEmail(email,user.EmailPeriod);}.bind(null,user.email,user.EmailPeriod));}});}else{cov_d0ggvfs9s.b[8][1]++;cov_d0ggvfs9s.s[71]++;models.User.getUserByEmail(email,user=>{cov_d0ggvfs9s.f[13]++;cov_d0ggvfs9s.s[72]++;if(user.isNotificationEmail===1){cov_d0ggvfs9s.b[10][0]++;const date=(cov_d0ggvfs9s.s[73]++,new Date(user.TimeOption));const rule=(cov_d0ggvfs9s.s[74]++,createRule(date,user.EmailPeriod));const j=(cov_d0ggvfs9s.s[75]++,schedule.scheduleJob(rule,function(email,EmailPeriod){cov_d0ggvfs9s.f[14]++;cov_d0ggvfs9s.s[76]++;sendNewNotificationToEmail(email,EmailPeriod);}.bind(null,user.email,user.EmailPeriod)));const item=(cov_d0ggvfs9s.s[77]++,{email:user.email.toUpperCase(),job:j,EmailPeriod:user.EmailPeriod});cov_d0ggvfs9s.s[78]++;insertItem(item);}else{cov_d0ggvfs9s.b[10][1]++;}});}},// send email feed back in here
// this function use libary cron-job of node-js
sendMailFeedbackJob:function(){cov_d0ggvfs9s.f[15]++;var arrUser;var job=(cov_d0ggvfs9s.s[79]++,new CronJob({cronTime:'00 00 10 * * 0-6',onTick:function(){cov_d0ggvfs9s.f[16]++;cov_d0ggvfs9s.s[80]++;// Send email in here bla bla :D
models.emailFeedback.getAllInfoAboutUserDontFeedback(function(rs){cov_d0ggvfs9s.f[17]++;cov_d0ggvfs9s.s[81]++;arrUser=rs;cov_d0ggvfs9s.s[82]++;for(let i=0;i<arrUser.length;i++){cov_d0ggvfs9s.s[83]++;// add email info to email_feedback in sql
models.emailFeedback.add(arrUser[i].email,arrUser[i].traineeId,arrUser[i].classId);// get course name array by class id, call function
cov_d0ggvfs9s.s[84]++;models.Course.getCourseNameByClassId(arrUser[i].classId,result=>{cov_d0ggvfs9s.f[18]++;cov_d0ggvfs9s.s[85]++;sendEmail.send(arrUser[i].email,"Please feed back courses which you learned","You have "+result[0].name+" course which need to be feedbacked",7);});}});},start:false,timeZone:'Asia/Ho_Chi_Minh'}));cov_d0ggvfs9s.s[86]++;job.start();}});cov_d0ggvfs9s.s[87]++;module.exports=automatic;